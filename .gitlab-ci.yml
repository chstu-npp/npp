stages:
  - build
  - deploy

variables:
  NAMESPACE: npp

build-and-push:
  stage: build
  image: docker:24
  services:
    - name: docker:24-dind
      alias: docker
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache git
    - until docker info >/dev/null 2>&1; do sleep 1; done
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - git fetch --tags
    - APP_VERSION=$(git describe --tags --always --dirty)
    - echo "Building version $APP_VERSION"
    - >
      docker build 
      --build-arg VERSION=$APP_VERSION 
      -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA 
      -t $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

deploy:
  stage: deploy
  image: alpine/helm:3.14.0
  before_script:
    - apk add --no-cache kubectl
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_DATA" | base64 -d > ~/.kube/config
    - chmod 600 ~/.kube/config
  script:
    - kubectl get namespace $NAMESPACE || kubectl create namespace $NAMESPACE
    - |
      kubectl create secret docker-registry gitlab-registry \
        --docker-server=$CI_REGISTRY \
        --docker-username=$CI_REGISTRY_USER \
        --docker-password=$CI_REGISTRY_PASSWORD \
        --namespace=$NAMESPACE \
        --dry-run=client -o yaml | kubectl apply -f -
    - helm dependency build ./k8s/ui
    - |
      helm upgrade --install ui ./k8s/ui \
      --namespace $NAMESPACE \
      --set image.repository=$CI_REGISTRY_IMAGE \
      --set image.tag=$CI_COMMIT_SHORT_SHA \
      --wait \
      --timeout 300s \
      --atomic
  rules:
    - if: $CI_COMMIT_BRANCH == "main"